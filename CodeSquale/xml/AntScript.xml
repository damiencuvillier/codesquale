<!-- Parsing tasks -->

<!--
	Ressources : 
	http://ant.apache.org/manual/CoreTasks/style.html
-->
<project name="CodeSquale Scripts" 
	default="CodeSqualeMetricsProcess"
	basedir="." >

	<description>
		Tests Scripts
		
		For developers only
	</description>
	
	<!-- values are setted by programmation 
		Values here are only used for test use -->
	<property name="OutputDir" value="d:\tmp\out\" />
	<property name="SourceDir" value="d:\tmp\src\" />
	
	<!-- Subdirs of outputdir -->
	<property name="AntLRXMLdir" value="Data\01.Antlr\" />
	<property name="CodeSqualeXMLdir" value="Data\02.ProjectData\" />
	<property name="MetricsDir" value="Data\03.Metrics\" />
	<property name="ReportDir" value="Report\" />
	
	<property name="XSDdir" value="XSD Schemas/" />
	<property name="XSLTdir" value="XSLT StyleSheets/Java/" />
	 
	<property name="antlrFile" value="" />
	<property name="tmpFile" value="tmp" />

	<taskdef name="CodeSqualeAntlrProcess" 
		classname="com.codesquale.ant.AntLRTask" 
		/>
	<taskdef name="CodeSqualeMetricsProcess" 
		classname="com.codesquale.ant.MetricsTask"
		/>
	

	 
	<target name="CodeSqualeInit" >
		<echo message="********************************" />
		<echo message="******** CodeSquale ***********" />
		<echo message="********************************" />		
		
		<!-- Environment initialization -->
		<echo message="Create Results dir" />
		
		<!-- Delete files if output dir already exists -->
		<delete failonerror="false">
			<fileset dir="${OutputDir}" >
				<include name="**/*.xml"/>
			</fileset>
		</delete>
		
		<!-- Create output dir -->
		<mkdir dir="${OutputDir}" />
		<mkdir dir="${OutputDir}/${CodeSqualeXMLdir}" />
		<mkdir dir="${OutputDir}/${ReportDir}" />
		<mkdir dir="${OutputDir}/${AntLRXMLdir}" />	
		<mkdir dir="${OutputDir}/${AntLRXMLdir}xmlOutput" />
		<mkdir dir="${OutputDir}/${MetricsDir}" />		
		
	</target>
					
	
	<target name="CodeSqualeAntlrProcess" 
			depends="CodeSqualeInit">
		<!-- Browse files and build a project file & antlr xml content -->
		<echo message="Browsing source code" />
		<CodeSqualeAntlrProcess source="${SourceDir}"
								target="${OutputDir}/${AntLRXMLdir}"
		/>
	</target>
	
	<!-- CodeSquale XML Process -->
	<target name="CodeSqualeXSLTProcess" depends="CodeSqualeAntlrProcess" >
		<!-- 
			Transforming antlr files to codesquale format file
		-->
		<echo message="Parse xml files from antlr Format to CodeSquale Format" />
		
		<!-- XSD Schemas files copy -->
		<echo level="info" message="XSD SCHEMA COPYING..." />
		<copy todir="${OutputDir}/${CodeSqualeXMLdir}">
			<fileset dir="${basedir}/${XSDdir}" > 
				<include name="**/*.xsd"/>
			</fileset>
		</copy>
		
		<echo message="Project exploring ... " />
		<xslt basedir="." processor="trax" 
			in="${OutputDir}/${AntLRXMLdir}AntlrProjectOutput.xml"
			out="${OutputDir}/${CodeSqualeXMLdir}project.xml"
			extension="xml" 
			description="Project File parsing"
			style="${XSLTdir}project.xslt"
			>
			<factory name="org.apache.xalan.processor.TransformerFactoryImpl" />	
		</xslt>
		<!-- Directory Parsing -->
		<echo message="Directories Exploring ..." />
		
		<xslt basedir="." processor="trax"
			in="${OutputDir}/${AntLRXMLdir}AntlrProjectOutput.xml"
			out="${OutputDir}/${CodeSqualeXMLdir}/${tmpFile}"
			extension="xml" 
			description="Directory files parsing"
			style="${XSLTdir}directory.xslt"
			>
			<factory name="org.apache.xalan.processor.TransformerFactoryImpl" />
		</xslt>
		
		
		<!-- Delete Temporary File -->
		<echo level="info" message="Deleting Temporary files" />
		<delete file="${OutputDir}/${CodeSqualeXMLdir}/${tmpFile}" />
		
		<echo message="AntLRtoCodeSqualeXML transition done"/>
	</target>
	
	<target name="CodeSqualeMetricsProcess" depends="CodeSqualeXSLTProcess">
		<echo message="Metrics are being calculating" />
		<!-- FIXME Why metricsProcess does not work in eclipse ? -->
		<CodeSqualeMetricsProcess outputDir="${OutputDir}\${MetricsDir}" queryFile="XQuery/saxon/DirectoryFileCounters.xquery">
			<fileset dir="${OutputDir}\${CodeSqualeXMLdir}">
				<include name="*.xml"/>
				<exclude name="project.xml" />
			</fileset>
		</CodeSqualeMetricsProcess>
		
		<echo message="CodeSquale has done his job" />
		<echo message="You can read LoggingInfo.html file for more details" />
	</target>

	
	

</project>



	
