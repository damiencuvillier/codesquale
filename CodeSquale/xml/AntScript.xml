<!-- Parsing tasks -->

<!--
	Ressources : 
	http://ant.apache.org/manual/CoreTasks/style.html
-->
<project name="CodeSquale Scripts" default="CodeSqualeMetricsProcess" basedir="..">
	<description>
		Tests Scripts
		
		For developers only
	</description>
	<property name="OutputDir" value="f:/w/tmp/generated/" />
	<property name="SourceDir" value="f:/w/tmp/src/" />
	

	
	<property name="AntLRXMLdir" value="${OutputDir}XMLAntlr/" />
	<property name="CodeSqualeXMLdir" value="${OutputDir}CodeSqualeXML/" />
	<property name="MetricsDir" value="${OutputDir}metricsXML/" />
	
	<property name="XSDdir" value="xml/XSD Schemas/" />
	<property name="XSLTdir" value="xml/XSLT StyleSheets/Java/" />
	 
	<property name="antlrFile" value="" />
	<property name="tmpFile" value="${OutputDir}tmp" />
	
	<taskdef name="CodeSqualeAntlrProcess" 
		classname="com.codesquale.ant.AntLRTask"/>
	<taskdef name="CodeSqualeMetricsProcess" 
		classname="com.codesquale.ant.MetricsTask"/>

	<target name="init">
		<echo message="********************************" />
		<echo message="******** CodeSquale ***********" />
		<echo message="********************************" />		
		<!-- Environment initialization -->
		<echo message="Create Results dir" level="info" />
		
		<mkdir dir="${OutputDir}" />
		<mkdir dir="${CodeSqualeXMLdir}" />
		<mkdir dir="${AntLRXMLdir}" />	
		<mkdir dir="${AntLRXMLdir}xmlOutput" />
		<mkdir dir="${MetricsDir}" />		
		
	</target>
					
	
	<target name="CodeSqualeAntlrProcess" depends="init">
		<!-- Browse files and build a project file & antlr xml content -->
		<echo level="info" message="Browsing source code" />
		<CodeSqualeAntlrProcess source="${SourceDir}"
								target="${AntLRXMLdir}"
		/>
	</target>
	
	<!-- CodeSquale XML Process -->
	<target name="CodeSqualeXMLProcess" depends="CodeSqualeAntlrProcess" >
		<!-- 
			Transforming antlr files to codesquale format file
		-->
		
		<echo level="info" message="Parse xml files from antlr Format to CodeSquale Format" />
		
		<!-- XSD Schemas files copy -->
		<echo level="info" message="XSD SCHEMA COPYING..." />
		<copy todir="${CodeSqualeXMLdir}">
			<fileset dir="${XSDdir}" > 
				<include name="**/*.xsd"/>
			</fileset>
		</copy>
		
		<echo level="info" message="Project exploring ... " />
		<xslt basedir="." processor="trax" 
			in="${AntLRXMLdir}AntlrProjectOutput.xml"
			out="${CodeSqualeXMLdir}project.xml"
			extension="xml" 
			description="Project File parsing"
			style="${XSLTdir}project.xslt"
			>
			<factory name="org.apache.xalan.processor.TransformerFactoryImpl" />
		</xslt>
		<!-- Directory Parsing -->
		<echo level="info" message="Directories Exploring ..." />
		<xslt basedir="." processor="trax" 
			in="${AntLRXMLdir}AntlrProjectOutput.xml"
			out="${CodeSqualeXMLdir}directories.xml"
			extension="xml" 
			description="Directory files parsing"
			style="${XSLTdir}directory.xslt"
			>
			<factory name="org.apache.xalan.processor.TransformerFactoryImpl" />
		</xslt>
		
		
		<!-- Delete Temporary File -->
		<echo level="info" message="Deleting Temporary files" />
		<delete file="${tmpFile}" />
		
		
		<echo level="info" message="AntLRtoCodeSqualeXML transition done"/>
	</target>
	
	<target name="CodeSqualeMetricsProcess" depends="CodeSqualeXMLProcess">
		<property name="fileName" value="xml/XQuery/DirectoryFile.xquery"/>
		
        <java jar="libs/kawa-1.9.1.jar" fork="true">
        	<arg value="--xquery"/>
        	<arg value="${fileName}"/>
        </java>
	</target>
	
	<!--
	One file test (file.xslt & class.xslt tests)
	<target name="parseOneFile" depends="init" 
			description="Parsing test">
			
			<xslt basedir="." 
				in="${antlrFile}"
				out="${tmpFile}"
				extension="xml" 
				description="Parse un fichier"
				style="XSLT StyleSheets/Java/file.xslt"
				/>
			<delete file="${tmpFile}" />
		</target>
	-->

</project>



	
