<!-- Parsing tasks -->

<!--
	Ressources : 
	http://ant.apache.org/manual/CoreTasks/style.html
-->
<project name="CodeSquale Scripts" default="CodeSqualeMetricsProcess" basedir="..">
	<description>
		Tests Scripts
		
		For developers only
	</description>
	
	<!-- values are setted by programmation 
		Values here are only used for test use -->
	<property name="OutputDir" value="d:\tmp\out\" />
	<property name="SourceDir" value="d:\tmp\src\" />
	

	<!-- Subdirs of outputdir -->
	<property name="AntLRXMLdir" value="XMLAntlr/" />
	<property name="CodeSqualeXMLdir" value="CodeSqualeXML/" />
	<property name="MetricsDir" value="metricsXML/" />
	
	<property name="XSDdir" value="xml/XSD Schemas/" />
	<property name="XSLTdir" value="xml/XSLT StyleSheets/Java/" />
	 
	<property name="antlrFile" value="" />
	<property name="tmpFile" value="tmp" />
	
	<taskdef name="CodeSqualeAntlrProcess" 
		classname="com.codesquale.ant.AntLRTask"/>
	<taskdef name="CodeSqualeMetricsProcess" 
		classname="com.codesquale.ant.MetricsTask"/>

	<target name="init">
		<echo message="********************************" />
		<echo level="warn" message="******** CodeSquale ***********" />
		<echo message="********************************" />		
		<!-- Environment initialization -->
		<echo level="warn" message="Create Results dir" />
		
		<mkdir dir="${OutputDir}" />
		<mkdir dir="${OutputDir}/${CodeSqualeXMLdir}" />
		<mkdir dir="${OutputDir}/${AntLRXMLdir}" />	
		<mkdir dir="${OutputDir}/${AntLRXMLdir}xmlOutput" />
		<mkdir dir="${OutputDir}/${MetricsDir}" />		
		
	</target>
					
	
	<target name="CodeSqualeAntlrProcess" depends="init">
		<!-- Browse files and build a project file & antlr xml content -->
		<echo level="warn" message="Browsing source code" />
		<CodeSqualeAntlrProcess source="${SourceDir}"
								target="${OutputDir}/${AntLRXMLdir}"
		/>
	</target>
	
	<!-- CodeSquale XML Process -->
	<target name="CodeSqualeXMLProcess" depends="CodeSqualeAntlrProcess" >
		<!-- 
			Transforming antlr files to codesquale format file
		-->
		
		<echo level="warn" message="Parse xml files from antlr Format to CodeSquale Format" />
		
		<!-- XSD Schemas files copy -->
		<echo level="info" message="XSD SCHEMA COPYING..." />
		<copy todir="${OutputDir}/${CodeSqualeXMLdir}">
			<fileset dir="${XSDdir}" > 
				<include name="**/*.xsd"/>
			</fileset>
		</copy>
		
		<echo level="warn" message="Project exploring ... " />
		<xslt basedir="." processor="trax" 
			in="${OutputDir}/${AntLRXMLdir}AntlrProjectOutput.xml"
			out="${OutputDir}/${CodeSqualeXMLdir}project.xml"
			extension="xml" 
			description="Project File parsing"
			style="${XSLTdir}project.xslt"
			>
			<factory name="org.apache.xalan.processor.TransformerFactoryImpl" />
		</xslt>
		<!-- Directory Parsing -->
		<echo level="warn" message="Directories Exploring ..." />
		<xslt basedir="." processor="trax" 
			in="${OutputDir}/${AntLRXMLdir}AntlrProjectOutput.xml"
			out="${OutputDir}/${CodeSqualeXMLdir}directories.xml"
			extension="xml" 
			description="Directory files parsing"
			style="${XSLTdir}directory.xslt"
			>
			<factory name="org.apache.xalan.processor.TransformerFactoryImpl" />
		</xslt>
		
		
		<!-- Delete Temporary File -->
		<echo level="info" message="Deleting Temporary files" />
		<delete file="${OutputDir}/${tmpFile}" />
		
		
		<echo level="warn" message="AntLRtoCodeSqualeXML transition done"/>
	</target>
	
	<target name="CodeSqualeMetricsProcess" depends="CodeSqualeXMLProcess">
		<echo level="warn" message="metrics are being calculating" />
		<CodeSqualeMetricsProcess outputDir="${OutputDir}/${MetricsDir}">
			<fileset dir="${OutputDir}/${CodeSqualeXMLdir}">
				<include name="*.xml"/>
				<exclude name="project.xml" />
			</fileset>
		</CodeSqualeMetricsProcess>
		
		<echo level="warn" message="CodeSquale has done his job" />
		<echo level="warn" message="You can read LoggingInfo.html file for more details" />
	</target>

	

</project>



	
